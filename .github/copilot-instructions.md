# Copilot / AI agent instructions for Creador Web PHP Puro

Summary
- Small, plain PHP web app (no framework). Server-rendered pages for auth flows (login/register/password reset). Use these notes to implement changes or PRs safely and consistently.

Big picture
- DB-backed app (MySQL). DB connection live in `db.php` (reads env vars).
- Authentication and most business logic live in `auth.php` (functions: `register_user`, `login_user`, `create_password_reset`, `verify_password_reset_token`, `reset_password_with_token`, etc.).
- Pages are simple PHP files in the repo root (`index.php`, `register.php`, `password_reset_request.php`, `password_reset.php`, `welcome.php`).
- Password-reset flow: token generated with `bin2hex(random_bytes(24))`, stored as `token_hash = hash('sha256', $token)` in `password_resets` (expires in 1 hour).
- Rate-limiting: reset requests recorded in `password_reset_requests` and checked with `is_allowed_reset_request` (default ~5/hour).
- Cleanup of expired tokens/old requests: `cleanup_password_resets.php` (intended to run via cron).

Key files & patterns (be specific)
- `db.php` — reads DB config from env vars (DB_HOST/DB_USER/DB_PASS/DB_NAME). Use `.env.example` as the source-of-truth for required env vars.
- `auth.php` — central functions used across pages. Prefer adding logic here when it affects multiple endpoints.
- `sql/` — contains DDL for `users`, `password_resets`, and `password_reset_requests` tables; run those SQL files during setup.
- `composer.json` — declares `phpmailer/phpmailer` as a dependency; email sending uses PHPMailer if available (falls back to `mail()`).
- `README.md` — contains important developer setup & cron recommendation.

Security & UX behavior to preserve
- Reset endpoints intentionally return the same generic messages whether an email exists (avoid user enumeration). Preserve that behavior.
- Tokens are stored hashed (`sha256`) and expire after 1 hour. Keep the same hashing/expiry pattern when making changes.
- Rate-limiting uses (`email` OR `ip`) checks in `password_reset_requests`. Keep the default check behavior unless explicitly changing policy.

Developer workflows (minimal, precise)
- Setup: run `composer install`, create DB and run SQL files in `sql/`, set env vars (see `.env.example`).
- Test a password-reset manually: 1) visit `password_reset_request.php`, 2) follow the email link (use `APP_BASE_URL` env to form links in `auth.php`), 3) open `password_reset.php?token=...` and submit.
- Run cleanup manually: `php cleanup_password_resets.php` (cron on production suggested in `README.md`).
- No automated tests exist in the repo currently; create tests only after discussing the test harness and PHP unit tooling to use.

Conventions & style
- Plain PHP scripts using `require_once` and procedural functions (no DI container or framework). Add helpers to `auth.php` or new files at root, keeping patterns consistent.
- Input is validated/parmeterized using `prepare()`/`bind_param` — continue using prepared statements to prevent SQL injection.
- Messages and comments are Spanish; keep messages consistent or add new translations if you change UI text.
- Commit message example in `README.md` uses Conventional-style prefixes (e.g., `feat:`). Follow that style for clarity.

Integration notes
- Email: check env vars SMTP_HOST/SMTP_USER/SMTP_PASS/SMTP_PORT/SMTP_SECURE and `MAIL_FROM`/`MAIL_FROM_NAME`. If PHPMailer is present via composer (vendor/autoload), code will use it; otherwise fallback to `mail()`.
- `APP_BASE_URL` controls links in reset emails (`auth.php` uses it when building reset links).

What to avoid changing without discussion
- The generic «If the email exists...» messaging for password resets (information leakage).
- Token hashing/storage semantics (switching algorithm or storage format requires migration and careful review).
- Rate-limiting logic changes (could affect abuse prevention) without tests and clear migration plan.

PR checklist for agents or contributors
1) Confirm env vars and DB are set (use `.env.example`).
2) Run `composer install` if touching email logic.
3) Run SQL files to set up schema before testing flows.
4) Manually verify the flow you modify (login/register/reset as applicable).
5) If changing tokens/rate-limits, document the change and add a short migration plan.

Questions / Next steps
- If you want, I can add short snippets for a typical dev setup script or a `Makefile` to codify local commands. Tell me which areas you'd like more detail on and I’ll update this doc.

---
*Generated by AI agent: concise, actionable, and tied to files: `auth.php`, `db.php`, `sql/*`, `cleanup_password_resets.php`, `.env.example`, `composer.json`, `README.md`.*
